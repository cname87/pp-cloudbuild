
apiVersion: skaffold/v2beta5
kind: Config
metadata:
  name: project-perform
build:
  # Defines where to find the Dockerfile build configurations at build time and the resulting image names and tags
  artifacts:
  - image: gcr.io/project-perform/pp-backend
    context: backend
    sync:
      manual:
        - src: 'dist/**/*'
          dest: /
  - image:  gcr.io/project-perform/pp-frontend
    context: frontend
    sync:
      manual:
        - src: 'dist/**/*'
          dest: /usr/share/www/
          strip: 'dist'
  tagPolicy:
    dateTime: {}
  # Use the locally-installed build tool (Docker) to build
  local: {
    # If not specified, push true only for remote clusters
    push: true
  }
deploy:
  statusCheckDeadlineSeconds: 300
  helm:
    releases:
      - name: project-perform
        chartPath: ../project-perform-k8es-cd/pp-chart
        valuesFiles:
          - pp-chart/values.yaml
        # Override keys in the values.yaml file
        artifactOverrides:
          frontend.image: gcr.io/project-perform/pp-frontend
          backend.image: gcr.io/project-perform/pp-backend
    # Additional option flags that are passed on the command line to helm.
    flags:
      # 20200816 Helm v3.2.2 bug requires this flag or upgrade after watch triggers an upgrade will fail - 'Service is immutable'
      upgrade: [ "--force=false" ]
portForward:
  # Forward frontend port 80 to localhost:8080
  # (localhost is seen as secure and avoids exception from Auth0)
- resourceType: service
  resourceName: project-perform-pp-chart-frontend-service
  namespace: default
  port: 80
  address: 127.0.0.1
  localPort: 8080
